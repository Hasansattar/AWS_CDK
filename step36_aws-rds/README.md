# AMAZON RELATIONAL DATABASE SERVICE
Amazon Relational Database Service (Amazon RDS) is a web service that makes it easier to set up, operate, and scale a relational database in the AWS Cloud. It provides cost-efficient, resizable capacity for an industry-standard relational database and manages common database administration tasks. Amazon RDS currently supports the MySQL, MariaDB, PostgreSQL, Oracle, and Microsoft SQL Server DB engines.

# Amazon RDS for MySql 
MySQL is the world's most popular open source relational database and Amazon RDS makes it easy to set up, operate, and scale MySQL deployments in the cloud. With Amazon RDS, you can deploy scalable MySQL servers in minutes with cost-efficient and resizable hardware capacity.
Amazon RDS for MySQL frees you up to focus on application development by managing time-consuming database administration tasks including backups, software patching, monitoring, scaling and replication.
Amazon RDS supports DB instances running several versions of MySQL.

# Amazon VPC
You run a database instance on a virtual private cloud (VPC) using the Amazon Virtual Private Cloud (Amazon VPC) service. When you use a VPC, you have control over your virtual networking environment.

# DB instances
The basic building block of Amazon RDS is the DB instance. A DB instance is an isolated database environment in the AWS Cloud. Your DB instance can contain multiple user-created databases. You can access your DB instance by using the same tools and applications that you use with a standalone database instance. 

# Starting a database instance 

# install & import modules:

`"@aws-cdk/aws-rds"` ,
`"@aws-cdk/aws-secretsmanager"` ,
`"@aws-cdk/aws-iam"` ,
`@aws-cdk/aws-ec2"`.

## Create a VPC
To set up a instance database, define a DatabaseInstance. You must always launch a database in a VPC. Use the vpcSubnets attribute to control whether your instances will be launched privately or publicly:
```javascript

// step #1: create a vpc for RDS instance

   const vpc = new ec2.Vpc(this, "myrdsvpc");
```

## Create a database instance
```javascript

 // step #2: create database instance
 
     const myDBInstance = new rds.DatabaseInstance(this, "MySQL", {
      instanceType: ec2.InstanceType.of(
        ec2.InstanceClass.BURSTABLE3,
        ec2.InstanceSize.SMALL
      ),
      vpc,
      engine: rds.DatabaseInstanceEngine.mysql({
        version: rds.MysqlEngineVersion.VER_5_6_39,
      }),
      publiclyAccessible: true,
      multiAz: false,
      allocatedStorage: 100,
      storageType: rds.StorageType.STANDARD,
      cloudwatchLogsExports: ["audit", "error", "general"],
      databaseName: "mySqlDataBase",
      deletionProtection: false,
      vpcPlacement: { subnetType: ec2.SubnetType.PUBLIC },
    });
```
# Construct Props include:

# Instances Engine (required)
Each DB instance runs a DB engine. Amazon RDS currently supports the MySQL, MariaDB, PostgreSQL, Oracle, and Microsoft SQL Server DB engines. Each DB engine has its own supported features, and each version of a DB engine may include specific features. Additionally, each DB engine has a set of parameters in a DB parameter group that control the behavior of the databases that it manages.

# DB instances class
The computation and memory capacity of a DB instance is determined by its DB instance class. 

# DB instances storage
DB instance storage comes in three types: Magnetic, General Purpose (SSD), and Provisioned IOPS (PIOPS). They differ in performance characteristics and price, there's no additional cost to run your DB instance in a VPC. 

# AWS Regions and Availability Zones
Amazon cloud computing resources are housed in highly available data center facilities in different areas of the world. Each data center location is called an AWS Region.Each AWS Region contains multiple distinct locations called Availability Zones, or AZs. You can run your DB instance in several Availability Zones, an option called a Multi-AZ deployment. 

# Setting Public Accessibility
You can set public accessibility for the database instance or cluster using the publiclyAccessible property. If you specify true, it creates an instance with a publicly resolvable DNS name, which resolves to a public IP address. If you specify false, it creates an internal instance with a DNS name that resolves to a private IP address. The default value depends on vpcSubnets. It will be true if vpcSubnets is subnetType: SubnetType.PUBLIC, false otherwise.

Available Instance Props:[DatabaseInstanceProps](https://docs.aws.amazon.com/cdk/api/latest/docs/@aws-cdk_aws-rds.DatabaseInstanceProps.html)

# Database Credentials
On creating a Database Instance, AWS will create Databse credentials with:
{username: "admin", 
password: "generated by aws", 
databaseName: "if not provided by us"
instanceIdentifier: "generated by aws",
resourceArn: "generated by aws", 
secretArn: "generated by aws",
InstanceEndpoint: "generated by aws"}

we would require this to access our database from within lambda either through secrets manager or environment variables

# Accessing your database
In order to access your MySQL database locally install MySQL Client on your system or use Online Tool MySQL Workbench using instances' endpoint(aka, host-name), database name and  password (in our case provided by AWS ).
In this step we will access our database with Lambda using a client library. For this we will provide permissions to lambda to have full access to RDS. Lambda would also require permission to access VPC, wherein the Database Instance is created.
```javascript

 // step #3: give lambda permissions to access RDS and VPC from aws managed policy
 
   const role = new iam.Role(this, "LambdaRole", {
      assumedBy: new iam.ServicePrincipal("lambda.amazonaws.com"),
      managedPolicies: [
        iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonRDSDataFullAccess"),
        iam.ManagedPolicy.fromAwsManagedPolicyName(
          "service-role/AWSLambdaVPCAccessExecutionRole"
        ),
      ],
    });
    
     // step #4: create a lambda function with role and vpc to access database providing database endpoint and database credential in environmental variables. 
 //  Lambda can access these through Secrets Manager too but for that lambda would require permission to access secrets manager too.
  
      // secret arn of database
      const dbcreds = myDBInstance.secret?.secretArn
      
      const hello = new lambda.Function(this, "HelloHandler", {
      runtime: lambda.Runtime.NODEJS_10_X,
      code: lambda.Code.fromAsset("lambda/lambda-p.zip"),
      handler: "index.handler",
      timeout: cdk.Duration.minutes(1),
      vpc,
      role,
      environment: {
        INSTANCE_CREDENTIALS: `${
          SM.Secret.fromSecretAttributes(this, "dbcredentials", { secretArn: dbcreds })
            .secretValue
        }`,
        HOST: myDBInstance.dbInstanceEndpointAddress,
      },
    });
    
        
    // step #5: create lambda once dbinstance is created as we have to provide credentials
    hello.node.addDependency(myDBInstance);
    
    // step #6: allow lambda to connect to the database instance

    myDBInstance.grantConnect(hello);
    .................................
```

# Connecting
To control who can access the cluster or instance, use the .connections attribute. RDS databases have a default port: 3306
```javascript

// step #6: create connection
  myDBInstance.connections.allowFromAnyIpv4(ec2.Port.tcp(3306))
```


#### Reference
[What is AWS Relational Database Service](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Welcome.html), 
[MySQL on AWS RDS](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_MySQL.html)

# Welcome to your CDK TypeScript project!

## Useful commands

 * `npm run build`   compile typescript to js
 * `npm run watch`   watch for changes and compile
 * `npm run test`    perform the jest unit tests
 * `cdk deploy`      deploy this stack to your default AWS account/region
 * `cdk diff`        compare deployed stack with current state
 * `cdk synth`       emits the synthesized CloudFormation template

